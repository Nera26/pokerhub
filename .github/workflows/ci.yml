name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  workflow-sla:
    runs-on: ubuntu-latest
    steps:
      - name: Verify recent DR drill
        id: dr-drill
        env:
          SLA_DAYS: 7
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          resp=$(curl -fsS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/dr-drill.yml/runs?per_page=1")
          ts=$(echo "$resp" | jq -r '.workflow_runs[0].updated_at')
          conclusion=$(echo "$resp" | jq -r '.workflow_runs[0].conclusion')
          echo "workflow=dr-drill.yml" >> $GITHUB_OUTPUT
          echo "timestamp=$ts" >> $GITHUB_OUTPUT
          echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
          now=$(date -u +%s)
          run_ts=$(date -d "$ts" -u +%s)
          max_age=$((SLA_DAYS * 86400))
          age=$((now - run_ts))
          if [ "$conclusion" != "success" ]; then
            echo "Latest dr-drill run concluded with $conclusion" >&2
            exit 1
          fi
          if [ "$age" -gt "$max_age" ]; then
            echo "Latest dr-drill run is older than ${SLA_DAYS}d" >&2
            exit 1
          fi

      - name: Prepare dr-drill SLA alert
        if: failure() && steps.dr-drill.outcome == 'failure'
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          cat <<'EOF' > dr-drill-sla.md
          Workflow: ${{ steps.dr-drill.outputs.workflow }}
          Last Run: ${{ steps.dr-drill.outputs.timestamp }}
          Conclusion: ${{ steps.dr-drill.outputs.conclusion }}
          EOF
          jq -n --arg channel "$SLACK_CHANNEL_ID" \
            --arg text "dr-drill.yml SLA check failed. Last run: ${{ steps.dr-drill.outputs.timestamp }} (conclusion: ${{ steps.dr-drill.outputs.conclusion }})." \
            '{channel: $channel, text: $text}' > dr-drill-slack.json
      - name: Slack alert (dr-drill SLA)
        if: failure() && steps.dr-drill.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          method: chat.postMessage
          payload-file-path: dr-drill-slack.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      - name: Create issue for dr-drill SLA
        if: failure() && steps.dr-drill.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "SLA breached: dr-drill"
          content-filepath: dr-drill-sla.md

      - name: Verify recent failover drill
        id: failover-drill
        env:
          SLA_DAYS: 7
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          resp=$(curl -fsS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/failover-drill.yml/runs?per_page=1")
          ts=$(echo "$resp" | jq -r '.workflow_runs[0].updated_at')
          conclusion=$(echo "$resp" | jq -r '.workflow_runs[0].conclusion')
          echo "workflow=failover-drill.yml" >> $GITHUB_OUTPUT
          echo "timestamp=$ts" >> $GITHUB_OUTPUT
          echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
          now=$(date -u +%s)
          run_ts=$(date -d "$ts" -u +%s)
          max_age=$((SLA_DAYS * 86400))
          age=$((now - run_ts))
          if [ "$conclusion" != "success" ]; then
            echo "Latest failover-drill run concluded with $conclusion" >&2
            exit 1
          fi
          if [ "$age" -gt "$max_age" ]; then
            echo "Latest failover-drill run is older than ${SLA_DAYS}d" >&2
            exit 1
          fi

      - name: Prepare failover-drill SLA alert
        if: failure() && steps.failover-drill.outcome == 'failure'
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          cat <<'EOF' > failover-drill-sla.md
          Workflow: ${{ steps.failover-drill.outputs.workflow }}
          Last Run: ${{ steps.failover-drill.outputs.timestamp }}
          Conclusion: ${{ steps.failover-drill.outputs.conclusion }}
          EOF
          jq -n --arg channel "$SLACK_CHANNEL_ID" \
            --arg text "failover-drill.yml SLA check failed. Last run: ${{ steps.failover-drill.outputs.timestamp }} (conclusion: ${{ steps.failover-drill.outputs.conclusion }})." \
            '{channel: $channel, text: $text}' > failover-drill-slack.json
      - name: Slack alert (failover-drill SLA)
        if: failure() && steps.failover-drill.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          method: chat.postMessage
          payload-file-path: failover-drill-slack.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      - name: Create issue for failover-drill SLA
        if: failure() && steps.failover-drill.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "SLA breached: failover-drill"
          content-filepath: failover-drill-sla.md

      - name: Ensure proof-archive recent success
        id: proof-archive
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          run=$(curl -fsS -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/proof-archive.yml/runs?per_page=1")
          conclusion=$(echo "$run" | jq -r '.workflow_runs[0].conclusion')
          started=$(echo "$run" | jq -r '.workflow_runs[0].run_started_at')
          echo "workflow=proof-archive.yml" >> $GITHUB_OUTPUT
          echo "timestamp=$started" >> $GITHUB_OUTPUT
          echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
          start_ts=$(date -d "$started" +%s)
          now=$(date -u +%s)
          if [ "$conclusion" != "success" ] || [ $((now - start_ts)) -gt 86400 ]; then
            echo "Latest proof-archive workflow run did not succeed within 24 hours" >&2
            exit 1
          fi

      - name: Prepare proof-archive SLA alert
        if: failure() && steps.proof-archive.outcome == 'failure'
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          cat <<'EOF' > proof-archive-sla.md
          Workflow: ${{ steps.proof-archive.outputs.workflow }}
          Last Run: ${{ steps.proof-archive.outputs.timestamp }}
          Conclusion: ${{ steps.proof-archive.outputs.conclusion }}
          EOF
          jq -n --arg channel "$SLACK_CHANNEL_ID" \
            --arg text "proof-archive.yml SLA check failed. Last run: ${{ steps.proof-archive.outputs.timestamp }} (conclusion: ${{ steps.proof-archive.outputs.conclusion }})." \
            '{channel: $channel, text: $text}' > proof-archive-slack.json
      - name: Slack alert (proof-archive SLA)
        if: failure() && steps.proof-archive.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          method: chat.postMessage
          payload-file-path: proof-archive-slack.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      - name: Create issue for proof-archive SLA
        if: failure() && steps.proof-archive.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "SLA breached: proof-archive"
          content-filepath: proof-archive-sla.md

      - uses: actions/checkout@v4
      - name: Verify proof archive integrity
        env:
          PROOF_ARCHIVE_BUCKET: ${{ secrets.PROOF_ARCHIVE_BUCKET }}
        run: npx -y ts-node scripts/check-proof-archive.ts

      - name: Ensure soak test recent success
        id: soak
        env:
          SLA_HOURS: 24
          GITHUB_TOKEN: ${{ github.token }}
          SOAK_TRENDS_BUCKET: ${{ secrets.SOAK_TRENDS_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          set -euo pipefail
          run=$(curl -fsS -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/soak.yml/runs?per_page=1")
          conclusion=$(echo "$run" | jq -r '.workflow_runs[0].conclusion')
          started=$(echo "$run" | jq -r '.workflow_runs[0].run_started_at')
          echo "workflow=soak.yml" >> $GITHUB_OUTPUT
          echo "timestamp=$started" >> $GITHUB_OUTPUT
          echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
          start_ts=$(date -d "$started" +%s)
          now=$(date -u +%s)
          max_age=$((SLA_HOURS * 3600))
          if [ "$conclusion" != "success" ] || [ $((now - start_ts)) -gt "$max_age" ]; then
            echo "Latest soak workflow run did not succeed within ${SLA_HOURS} hours" >&2
            exit 1
          fi
          npx ts-node --compiler-options '{"module":"commonjs"}' scripts/check-soak-metrics.ts

      - name: Prepare soak SLA alert
        if: failure() && steps.soak.outcome == 'failure'
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          cat <<'EOF' > soak-sla.md
          Workflow: ${{ steps.soak.outputs.workflow }}
          Last Run: ${{ steps.soak.outputs.timestamp }}
          Conclusion: ${{ steps.soak.outputs.conclusion }}
          EOF
          jq -n --arg channel "$SLACK_CHANNEL_ID" \
            --arg text "soak.yml SLA check failed. Last run: ${{ steps.soak.outputs.timestamp }} (conclusion: ${{ steps.soak.outputs.conclusion }})." \
            '{channel: $channel, text: $text}' > soak-slack.json
      - name: Slack alert (soak SLA)
        if: failure() && steps.soak.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          method: chat.postMessage
          payload-file-path: soak-slack.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      - name: Create issue for soak SLA
        if: failure() && steps.soak.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "SLA breached: soak"
          content-filepath: soak-sla.md

      - name: Ensure pg-restore-smoke recent success
        id: pg-restore-smoke
        env:
          SLA_MINUTES: 60
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          run=$(curl -fsS -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/pg-restore-smoke.yml/runs?per_page=1")
          conclusion=$(echo "$run" | jq -r '.workflow_runs[0].conclusion')
          started=$(echo "$run" | jq -r '.workflow_runs[0].run_started_at')
          echo "workflow=pg-restore-smoke.yml" >> $GITHUB_OUTPUT
          echo "timestamp=$started" >> $GITHUB_OUTPUT
          echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
          start_ts=$(date -d "$started" +%s)
          now=$(date -u +%s)
          max_age=$((SLA_MINUTES * 60))
          if [ "$conclusion" != "success" ] || [ $((now - start_ts)) -gt "$max_age" ]; then
            echo "Latest pg-restore-smoke workflow run did not succeed within ${SLA_MINUTES} minutes" >&2
            exit 1
          fi

      - name: Prepare pg-restore-smoke SLA alert
        if: failure() && steps.pg-restore-smoke.outcome == 'failure'
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          cat <<'EOF' > pg-restore-smoke-sla.md
          Workflow: ${{ steps.pg-restore-smoke.outputs.workflow }}
          Last Run: ${{ steps.pg-restore-smoke.outputs.timestamp }}
          Conclusion: ${{ steps.pg-restore-smoke.outputs.conclusion }}
          EOF
          jq -n --arg channel "$SLACK_CHANNEL_ID" \
            --arg text "pg-restore-smoke.yml SLA check failed. Last run: ${{ steps.pg-restore-smoke.outputs.timestamp }} (conclusion: ${{ steps.pg-restore-smoke.outputs.conclusion }})." \
            '{channel: $channel, text: $text}' > pg-restore-smoke-slack.json
      - name: Slack alert (pg-restore-smoke SLA)
        if: failure() && steps.pg-restore-smoke.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          method: chat.postMessage
          payload-file-path: pg-restore-smoke-slack.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      - name: Create issue for pg-restore-smoke SLA
        if: failure() && steps.pg-restore-smoke.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "SLA breached: pg-restore-smoke"
          content-filepath: pg-restore-smoke-sla.md

      - name: Verify recent spectator-privacy-nightly run
        id: spectator-privacy-nightly
        env:
          SLA_HOURS: 24
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          resp=$(curl -fsS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/spectator-privacy-nightly.yml/runs?per_page=1")
          ts=$(echo "$resp" | jq -r '.workflow_runs[0].updated_at')
          conclusion=$(echo "$resp" | jq -r '.workflow_runs[0].conclusion')
          echo "workflow=spectator-privacy-nightly.yml" >> $GITHUB_OUTPUT
          echo "timestamp=$ts" >> $GITHUB_OUTPUT
          echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
          now=$(date -u +%s)
          run_ts=$(date -d "$ts" -u +%s)
          max_age=$((SLA_HOURS * 3600))
          age=$((now - run_ts))
          if [ "$conclusion" != "success" ]; then
            echo "Latest spectator-privacy-nightly run concluded with $conclusion" >&2
            exit 1
          fi
          if [ "$age" -gt "$max_age" ]; then
            echo "Latest spectator-privacy-nightly run is older than ${SLA_HOURS}h" >&2
            exit 1
          fi

      - name: Prepare spectator-privacy-nightly SLA alert
        if: failure() && steps.spectator-privacy-nightly.outcome == 'failure'
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          cat <<'EOF' > spectator-privacy-sla.md
          Workflow: ${{ steps.spectator-privacy-nightly.outputs.workflow }}
          Last Run: ${{ steps.spectator-privacy-nightly.outputs.timestamp }}
          Conclusion: ${{ steps.spectator-privacy-nightly.outputs.conclusion }}
          EOF
          jq -n --arg channel "$SLACK_CHANNEL_ID" \
            --arg text "spectator-privacy-nightly.yml SLA check failed. Last run: ${{ steps.spectator-privacy-nightly.outputs.timestamp }} (conclusion: ${{ steps.spectator-privacy-nightly.outputs.conclusion }})." \
            '{channel: $channel, text: $text}' > spectator-privacy-slack.json
      - name: Slack alert (spectator-privacy-nightly SLA)
        if: failure() && steps.spectator-privacy-nightly.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          method: chat.postMessage
          payload-file-path: spectator-privacy-slack.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      - name: Create issue for spectator-privacy-nightly SLA
        if: failure() && steps.spectator-privacy-nightly.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "SLA breached: spectator-privacy-nightly"
          content-filepath: spectator-privacy-sla.md

      - name: Verify ops artifacts
        env:
          PROOF_ARCHIVE_BUCKET: ${{ secrets.PROOF_ARCHIVE_BUCKET }}
          SPECTATOR_PRIVACY_BUCKET: ${{ secrets.SPECTATOR_PRIVACY_BUCKET }}
          RUN_ID: ${{ github.run_id }}
          SOAK_TRENDS_BUCKET: ${{ secrets.SOAK_TRENDS_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: npx ts-node --compiler-options '{"module":"commonjs"}' scripts/verify-ops-artifacts.ts

  docs:
    needs: workflow-sla
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run docs:lint
      - run: npm run docs:check

  dr-runbook-check:
    needs: docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx ts-node scripts/check-dr-runbook.ts

  contracts:
    needs: [docs, dr-runbook-check]
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm ci --prefix backend
      - run: npm ci --prefix frontend
      - name: Backend contract tests
        run: npm run test:contracts --prefix backend
      - name: Frontend contract tests
        run: npm run test:contracts --prefix frontend

  proof-archive:
    needs: contracts
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: proof
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready" --health-interval 10s --health-timeout 5s --health-retries 5
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/proof
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm ci --legacy-peer-deps --prefix backend
      - name: Seed proof fixture
        run: psql "$DATABASE_URL" -f backend/test/fixtures/proof-hand.sql
      - name: Export proof
        run: npx -y ts-node scripts/export-hand-proof.ts 11111111-1111-1111-1111-111111111111
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
      - name: Validate proof archive
        run: npx -y ts-node scripts/validate-proof-archive.ts

  proof-archive-integration:
    needs: proof-archive
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm ci --legacy-peer-deps --prefix backend
      - name: Test proof archive migrations
        run: npx -y ts-node scripts/test-proof-archive-migrations.ts

  unit:
    needs:
      - contracts
      - proof-archive-integration
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: ./scripts/test-stages.sh unit | tee unit.log
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-${{ github.sha }}
          path: unit.log

  property:
    needs: unit
    if: ${{ always() }}
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: ./scripts/test-stages.sh property | tee property.log
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: property-${{ github.sha }}
          path: property.log

  spectator-privacy:
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    needs: property
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/spectator-privacy-check
      - name: Upload spectator privacy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spectator-privacy-logs-${{ github.sha }}
          path: |
            backend-tests.log
            frontend-tests.log

  integration:
    needs: spectator-privacy
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: ./scripts/test-stages.sh integration | tee integration.log
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-${{ github.sha }}
          path: integration.log

  e2e:
    needs: integration
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: ./scripts/test-stages.sh e2e | tee e2e.log
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-${{ github.sha }}
          path: e2e.log

  load:
    needs: e2e
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - uses: grafana/setup-k6@v1
      - run: |
          mkdir -p load/results
          k6 run load/k6-swarm.js --vus 10 --duration 10s --summary-export=load/results/summary.json | tee load/results/k6.log
      - run: load/check-thresholds.sh load/results/summary.json
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-${{ github.sha }}
          path: |
            load/results/summary.json
            load/results/k6.log

  chaos:
    needs: load
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - uses: grafana/setup-k6@v1
      - run: ./scripts/test-stages.sh chaos | tee chaos.log
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chaos-${{ github.sha }}
          path: chaos.log

  soak:
    needs: chaos
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - uses: grafana/setup-k6@v1
      - run: |
          mkdir -p load/results
          k6 run load/k6-ws-soak.js --vus 10 --duration 30s --summary-export=load/results/ws-soak-summary.json
      - run: load/check-thresholds.sh load/results/ws-soak-summary.json metrics/gc-histogram.json metrics/heap-histogram.json metrics/cpu-histogram.json
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Download latest baseline
        run: aws s3 sync "s3://${{ secrets.SOAK_TRENDS_BUCKET }}/soak/latest/" baseline || true
      - name: Threshold check against baseline
        id: threshold
        run: |
          if [ -f baseline/baseline.json ]; then
            npx ts-node --compiler-options '{"module":"commonjs"}' scripts/analyze-soak-trends.ts metrics baseline
          else
            echo "No baseline to compare against"
          fi
      - name: Open soak regression issue
        if: failure() && steps.threshold.outcome == 'failure'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: Soak trends regression detected
          content-filepath: metrics/baseline.json
      - name: Prepare soak regression Slack payload
        if: failure() && steps.threshold.outcome == 'failure'
        run: jq -Rs '{channel: env.SLACK_CHANNEL_ID, text: .}' metrics/baseline.json > slack-payload.json
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
      - name: Slack soak regression alert
        if: failure() && steps.threshold.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          method: chat.postMessage
          payload-file-path: slack-payload.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      - name: Sync soak metrics
        if: always()
        run: |
          aws s3 sync metrics "s3://${{ secrets.SOAK_TRENDS_BUCKET }}/soak-${{ github.run_id }}/"
          aws s3 sync metrics "s3://${{ secrets.SOAK_TRENDS_BUCKET }}/soak/latest/"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: soak-${{ github.sha }}
          path: |
            load/results/ws-soak-summary.json
            metrics/gc-histogram.json
            metrics/heap-histogram.json
            metrics/cpu-histogram.json
            metrics/baseline.json
