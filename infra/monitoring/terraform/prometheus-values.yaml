alertmanager:
  config: |
    global: {}
    route:
      receiver: 'null'
      routes:
        - match_re:
            pagerduty_service: .+
          receiver: pagerduty
    receivers:
      - name: pagerduty
        pagerduty_configs:
          - routing_key: ${pagerduty_routing_key}
serverFiles:
  alerts:
    slo-alerts.yaml: |
      groups:
      - name: burnrate-recordings
        rules:
        - record: action_ack_latency_error_budget_burn_rate_1h
          expr: (1 - sum(rate(game_action_ack_latency_ms_bucket{le="250"}[1h])) / sum(rate(game_action_ack_latency_ms_count[1h]))) / (1 - 0.99)
        - record: action_ack_latency_error_budget_burn_rate_6h
          expr: (1 - sum(rate(game_action_ack_latency_ms_bucket{le="250"}[6h])) / sum(rate(game_action_ack_latency_ms_count[6h]))) / (1 - 0.99)
        - record: socket_connect_error_budget_burn_rate_1h
          expr: (1 - sum(rate(socket_success_total[1h])) / sum(rate(socket_requests_total[1h]))) / (1 - 0.99)
        - record: socket_connect_error_budget_burn_rate_6h
          expr: (1 - sum(rate(socket_success_total[6h])) / sum(rate(socket_requests_total[6h]))) / (1 - 0.99)
      - name: uptime
        rules:
        - alert: ServiceUptimeSLO
          expr: (sum(rate(http_requests_total{status!~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) < 0.999
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Service uptime below SLO"
            description: "Less than 99.9% of requests are succeeding."
      - name: ack-latency
        rules:
        - alert: AckLatencySLO
          expr: histogram_quantile(0.99, sum(rate(ack_latency_seconds_bucket[5m])) by (le)) > 0.25
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: "ACK latency above SLO"
            description: "99th percentile ACK latency > 250ms."
      - name: slo-burn-rate
        rules:
        - alert: LatencySLOBurnRate1h
          expr: latency_error_budget_burn_rate_1h > 14.4
          for: 2m
          labels:
            severity: critical
            pagerduty_service: pokerhub-sre
          annotations:
            summary: "1h latency error budget burn rate too high"
        - alert: LatencySLOBurnRate6h
          expr: latency_error_budget_burn_rate_6h > 6
          for: 15m
          labels:
            severity: critical
            pagerduty_service: pokerhub-sre
          annotations:
            summary: "6h latency error budget burn rate too high"
        - alert: ErrorRateSLOBurnRate1h
          expr: request_error_budget_burn_rate_1h > 14.4
          for: 2m
          labels:
            severity: critical
            pagerduty_service: pokerhub-sre
          annotations:
            summary: "1h error rate budget burn rate too high"
        - alert: ErrorRateSLOBurnRate6h
          expr: request_error_budget_burn_rate_6h > 6
          for: 15m
          labels:
            severity: critical
            pagerduty_service: pokerhub-sre
          annotations:
            summary: "6h error rate budget burn rate too high"
        - alert: ActionAckLatencySLOBurnRate1h
          expr: action_ack_latency_error_budget_burn_rate_1h > 14.4
          for: 2m
          labels:
            severity: critical
            pagerduty_service: pokerhub-sre
          annotations:
            summary: "1h action ACK latency burn rate too high"
        - alert: ActionAckLatencySLOBurnRate6h
          expr: action_ack_latency_error_budget_burn_rate_6h > 6
          for: 15m
          labels:
            severity: critical
            pagerduty_service: pokerhub-sre
          annotations:
            summary: "6h action ACK latency burn rate too high"
        - alert: SocketConnectSuccessSLOBurnRate1h
          expr: socket_connect_error_budget_burn_rate_1h > 14.4
          for: 2m
          labels:
            severity: critical
            pagerduty_service: pokerhub-sre
          annotations:
            summary: "1h socket connect success burn rate too high"
        - alert: SocketConnectSuccessSLOBurnRate6h
          expr: socket_connect_error_budget_burn_rate_6h > 6
          for: 15m
          labels:
            severity: critical
            pagerduty_service: pokerhub-sre
          annotations:
            summary: "6h socket connect success burn rate too high"
